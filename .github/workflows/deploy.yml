name: Deploy with Ansible

on:
  workflow_run:
    workflows: ["Build and Publish Docker image"]
    types: 
      - completed
  workflow_dispatch:

# Principe du moindre privilÃ¨ge - permissions explicites
permissions:
  contents: read
  id-token: write  # Pour OIDC si nÃ©cessaire
  issues: write    # Pour manual-approval

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
  TF_VAR_api_token: ${{ secrets.API_TOKEN }}

jobs:

  # ğŸ” VÃ©rifier que le build a rÃ©ussi (si dÃ©clenchÃ© par workflow_run)
  # et rÃ©cupÃ©rer la version
  version:
    runs-on: ubuntu-latest
    # Ne pas dÃ©ployer si le build a Ã©chouÃ©
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      version: ${{ steps.gettag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get tag
        id: gettag
        run: |
          echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

  # ğŸ” DÃ©tecter si les fichiers Terraform ont changÃ©
  # Permet de skip Terraform si seul le code applicatif a changÃ©
  check-changes:
    name: Detect Infrastructure Changes
    runs-on: ubuntu-latest
    needs: version
    outputs:
      terraform_changed: ${{ steps.changes.outputs.terraform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Besoin du commit prÃ©cÃ©dent pour comparer

      - name: Check for Terraform changes
        id: changes
        run: |
          # Comparer les fichiers modifiÃ©s avec le commit prÃ©cÃ©dent
          if git diff --name-only HEAD~1 HEAD | grep -q '^terraform/'; then
            echo "terraform=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Changements Terraform dÃ©tectÃ©s"
          else
            echo "terraform=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Pas de changement Terraform â€” skip infra"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ—ï¸ BRANCHE TERRAFORM (conditionnelle)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  terraform-plan:
    name: Terraform - init and plan
    runs-on: ubuntu-latest
    needs: check-changes
    # Ne s'exÃ©cute que si des fichiers terraform/ ont changÃ©
    if: needs.check-changes.outputs.terraform_changed == 'true'
    outputs:
      inventory_artifact: terraform_plan

    steps:
      - name: Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4
      
      - name: Installation de Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.10.5"

      - name: Substitution des placeholders dans backend.tfvars
        env:
          S3_NAME: ${{vars.S3_BUCKET}}
          S3_KEY: ${{vars.S3_KEY}}
          S3_REGION: ${{vars.S3_REGION}}
          S3_ENDPOINT_URL: ${{vars.S3_ENDPOINT_URL}}
        run: |
          cd terraform
          envsubst < backend.tfvars.example > backend.tfvars
      
      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend-config=backend.tfvars

      - name: Create Artifact Folder 
        shell: bash
        run: |
          sudo mkdir -p -m777 ${{ github.workspace }}/tfplanoutput

      - name: Terraform plan
        run: |
          cd terraform
          terraform plan -out=${{ github.workspace }}/tfplanoutput/tf.plan
      
      - name: Upload du plan Terraform (artefact)
        uses: actions/upload-artifact@v4
        with:
          name: terraform_plan
          path: ${{ github.workspace }}/tfplanoutput/
          if-no-files-found: error


  manual-approval-tf:
    name: Manual Approval - Terraform
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.result == 'success'
    steps:
      - name: Await Manual Approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: vde-dis
          minimum-approvals: 1
          issue-title: "ğŸ—ï¸ Approval Required â€” Terraform Apply"
          issue-body: |
            Un `terraform plan` a Ã©tÃ© exÃ©cutÃ© avec succÃ¨s.
            Veuillez approuver ou refuser l'application des changements d'infrastructure.


  terraform-apply:
    name: Terraform - apply
    runs-on: ubuntu-latest
    needs: manual-approval-tf
    steps:
      - name: Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4
      
      - name: Installation de Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.10.5"
      
      - name: Substitution des placeholders dans backend.tfvars
        env:
          S3_NAME: ${{vars.S3_BUCKET}}
          S3_KEY: ${{vars.S3_KEY}}
          S3_REGION: ${{vars.S3_REGION}}
          S3_ENDPOINT_URL: ${{vars.S3_ENDPOINT_URL}}
        run: |
          cd terraform
          envsubst < backend.tfvars.example > backend.tfvars
    
      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend-config=backend.tfvars

      - name: Download du plan Terraform (artefact)
        uses: actions/download-artifact@v4
        with:
          name: terraform_plan
          path: ${{ github.workspace }}/terraform/tfplanoutput

      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply "tfplanoutput/tf.plan"
      
      - name: VÃ©rifier la prÃ©sence de l'inventaire
        run: |
          cd terraform
          if [ -f "${PWD}/inventory" ]; then
            echo "âœ… L'inventaire a Ã©tÃ© gÃ©nÃ©rÃ© : ${PWD}/inventory"
          else
            echo "âŒ Erreur : fichier inventory non trouvÃ©"
            exit 1
          fi
      
      - name: Upload de l'inventaire (artefact)
        uses: actions/upload-artifact@v4
        with:
          name: terraform_inventory
          path: terraform/inventory

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸš€ BRANCHE ANSIBLE (toujours exÃ©cutÃ©e)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  manual-approval-ansible:
    name: Manual Approval - Ansible
    runs-on: ubuntu-latest
    # Attend Terraform si des changements infra, sinon attend juste check-changes
    needs: [check-changes, terraform-apply]
    # S'exÃ©cute si Terraform a rÃ©ussi OU a Ã©tÃ© skipped (pas de changement infra)
    if: |
      always() && 
      (needs.terraform-apply.result == 'success' || needs.terraform-apply.result == 'skipped')
    steps:
      - name: Await Manual Approval Ansible
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: vde-dis
          minimum-approvals: 1
          issue-title: "ğŸš€ Approval Required â€” Ansible Deploy"
          issue-body: |
            L'infrastructure est prÃªte. Veuillez approuver ou refuser le dÃ©ploiement applicatif via Ansible.

  ansible:
    name: ExÃ©cuter Ansible
    runs-on: ubuntu-latest
    needs: [manual-approval-ansible, version]
    steps:
      - name: Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4
      
      - name: TÃ©lÃ©charger l'inventaire gÃ©nÃ©rÃ© par Terraform
        uses: actions/download-artifact@v4
        with:
          name: terraform_inventory
          path: inventory

      - name: PrÃ©parer la clÃ© privÃ©e pour Ansible
        run: |
          cat <<EOF > private_key.pem
          ${{ secrets.SSH_PRIVATE_KEY }}
          EOF
          chmod 600 private_key.pem
      
      - name: Installation d'Ansible
        run: |
          # sudo apt update && sudo apt upgrade
          sudo apt install -y ansible

      - name: Run Ansible Playbook
        env:
          ANSIBLE_USER: ${{ secrets.ANSIBLE_USER }}
          ANSIBLE_HOST_KEY_CHECKING: False
        run: |
          ansible-playbook -i inventory ansible/playbook.yml \
            --private-key private_key.pem \
            -u ${{ secrets.ANSIBLE_USER }} \
            --ssh-common-args='-o StrictHostKeyChecking=no' \
            --extra-vars ansible_user=${{ secrets.ANSIBLE_USER }} \
            --extra-vars registry_username=${{ github.repository_owner }} \
            --extra-vars registry_token=${{ secrets.GITHUB_TOKEN }} \
            --extra-vars image_name=ghcr.io/${{ github.repository }}:${{ needs.version.outputs.version }}
