name: "ðŸ”§ Deploy â€” Configuration (Ansible)"

on:
  workflow_dispatch:
    inputs: {}

permissions:
  contents: read

jobs:

  configure:
    name: Ansible â€” Hardening & Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      # â”€â”€ Inventaire â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # On tente de rÃ©cupÃ©rer l'inventaire gÃ©nÃ©rÃ© par Terraform.
      # S'il n'existe pas (premier run, ou expirÃ©), on utilise
      # l'inventaire statique commitÃ© dans le repo.

      - name: TÃ©lÃ©charger l'inventaire Terraform (si disponible)
        uses: actions/download-artifact@v4
        with:
          name: terraform_inventory
          path: ansible/terraform_inventory
        continue-on-error: true

      - name: SÃ©lectionner l'inventaire
        id: inventory
        run: |
          if [ -f "ansible/terraform_inventory/inventory" ]; then
            echo "path=ansible/terraform_inventory/inventory" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Inventaire Terraform rÃ©cupÃ©rÃ©"
          else
            echo "path=ansible/inventory.ini" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Utilisation de l'inventaire statique (inventory.ini)"
          fi

      # â”€â”€ SSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: PrÃ©parer la clÃ© privÃ©e SSH
        run: |
          install -m 600 /dev/null private_key.pem
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem

      # â”€â”€ Ansible â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Installer Ansible via pip
        run: |
          pip install ansible

      - name: Installer les collections Ansible
        run: |
          ansible-galaxy collection install -r ansible/requirements.yml -p ansible/collections

      - name: ExÃ©cuter le playbook de configuration
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          ansible-playbook \
            -i ${{ steps.inventory.outputs.path }} \
            ansible/playbook.yml \
            --private-key private_key.pem \
            -u ${{ secrets.ANSIBLE_USER }} \
            --ssh-common-args='-o StrictHostKeyChecking=no'

      # â”€â”€ Cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Nettoyage de la clÃ© SSH
        if: always()
        run: |
          rm -f private_key.pem
